#include <iostream>

#include "memory.hpp"
// generated by xxd -i ...
#include "48rom.h"
#include "diagrom.h"
#include "diagrom2.h"
#include "1280.h"
#include "1281.h"

Memory::Memory()
{
    // clear all 128k memory
    for (int i = 0; i < 7; i++)
    {
        for (int b = 0; b < 16384; b++)
        {
            bank[i][b] = 0x00;
        }
    }
    canWriteRom = false;
    is48 = true;
    bankMapping[0] = 0; // 0 ROM - specially, mapped to 0x0000-0x3fff
    bankMapping[1] = 5; // bank 5 mapped to 0x4000-0x7fff
    bankMapping[2] = 2; // bank 2 always mapped to 0x8000-0xbfff
    bankMapping[3] = 0; // bank 0 mapped 0xc000-0xffff
}

void Memory::writePort(uint16_t port, uint8_t value)
{
    if (port == 0x7ffd)
    {
        if (is48)
        {
            printf("Memory: We are in 48k, so ignoring write to 7ffd\n");
        }
        else
        {
            printf("%x port\n", port);
        }
    }
}

uint8_t Memory::ReadByte(uint16_t address)
{
    if (address <= 0x3fff) // ROM 0 or ROM 1
    {
        return rom[bankMapping[0]][address];
    }
    if (address >= 0x4000 && address < 0x8000)
    {
        return bank[bankMapping[1]][address-0x4000];
    }
    if (address >= 0x8000 && address < 0xc000)
    {
        return bank[bankMapping[2]][address-0x8000];
    }
    // address >= 0xc000
    return bank[bankMapping[3]][address-0xc000];
}

void Memory::WriteByte(uint16_t address, uint8_t value)
{
    if (address < 0x4000 && canWriteRom == false)
    {
        // printf("Ignoring attempt to write byte to ROM %x %x\n",address,value);
        return;
    }
    if (address <= 0x3fff) // ROM 0 or ROM 1
    {
        rom[bankMapping[0]][address] = value;
    }
    else if (address >= 0x4000 && address < 0x8000)
    {
        bank[bankMapping[1]][address-0x4000] = value;
    }
    else if (address >= 0x8000 && address < 0xc000)
    {
        bank[bankMapping[2]][address-0x8000] = value;
    }
    else // address >= 0xc000
    {
        bank[bankMapping[3]][address-0xc000] = value;
    }
}

void Memory::change48(bool is48s)
{
    is48 = is48s;
}

void Memory::Read48(void)
{
    canWriteRom = true;
    for (unsigned int i = 0; i < __48_rom_len; i++)
    {
        WriteByte(i, __48_rom[i]);
    }
    canWriteRom = false;
}

void Memory::ReadDiag(void)
{
    canWriteRom = true;
    for (unsigned int i = 0; i < testrom_bin_len; i++)
    {
        WriteByte(i, testrom_bin[i]);
    }
    canWriteRom = false;
}

void Memory::ReadDiag2(void)
{
    canWriteRom = true;
    for (unsigned int i = 0; i < DiagROMv_173_len; i++)
    {
        WriteByte(i, DiagROMv_173[i]);
    }
    canWriteRom = false;
}
